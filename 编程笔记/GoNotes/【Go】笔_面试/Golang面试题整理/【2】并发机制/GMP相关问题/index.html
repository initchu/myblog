
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="褚成志">
      
      
        <link rel="canonical" href="http://blog.chucz.asia/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/GoNotes/%E3%80%90Go%E3%80%91%E7%AC%94_%E9%9D%A2%E8%AF%95/Golang%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86/%E3%80%902%E3%80%91%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6/GMP%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/">
      
      
      
      
      <link rel="icon" href="../../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>GMP 相关问题 - 褚成志的技术博客</title>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#gmp" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../../../.." title="褚成志的技术博客" class="md-header__button md-logo" aria-label="褚成志的技术博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            褚成志的技术博客
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              GMP 相关问题
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../../.." title="褚成志的技术博客" class="md-nav__button md-logo" aria-label="褚成志的技术博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    褚成志的技术博客
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="gmp">GMP 相关问题</h1>
<h1 id="gmp_1">简单讲一讲（说一说） GMP 模型</h1>
<h2 id="_1"><font style="color:rgb(0, 0, 0);">题目解析</font></h2>
<h3 id="_2">三个字母的含义</h3>
<ul>
<li><code>**&lt;font style="color:rgb(0,0,0);"&gt;G（Goroutine）&lt;/font&gt;**</code><strong><font style="color:rgb(0,0,0);">：</font></strong><font style="color:rgb(0,0,0);">G 就是我们所说的 Go 语言中的协程 Goroutine 的缩写，</font><font style="color:rgb(51, 51, 51);">相当于操作系统中的进程控制块。</font><font style="color:rgb(0,0,0);">其中</font><font style="color:rgb(0, 0, 0);">存着 goroutine 的运行时栈信息，CPU 的一些寄存器的值以及执行的函数指令等。</font></li>
<li><code>**&lt;font style="color:rgb(0,0,0);"&gt;M（Machine）&lt;/font&gt;**</code><strong><font style="color:rgb(0,0,0);">：</font></strong><font style="color:rgb(0,0,0);">代表一个操作系统的主线程，对内核级线程的封装，数量对应真实的 CPU 数。</font><font style="color:rgb(0, 0, 0);">一个 M 直接关联一个 os 内核线程，用于执行 G。</font>M 会优先从关联的 P 的本地队列中直接获取待执行的 G。M 保存了 M 自身使用的栈信息、当前正在 M上执行的 G 信息、与之绑定的 P 信息。</li>
<li><code>**&lt;font style="color:rgb(0,0,0);"&gt;P（Processor）&lt;/font&gt;**</code><font style="color:rgb(0,0,0);">：</font><font style="color:rgb(0, 0, 0);">Processor 代表了 </font>M 所需<font style="color:rgb(0, 0, 0);">的上下文环境，</font>代表 M 运行 G 所需要的资源<font style="color:rgb(102, 102, 102);">。</font><font style="color:rgb(0, 0, 0);">是处理用户级代码逻辑的处理器，可以将其看作一个局部调度器使 go 代码在一个线程上跑。</font>当 P 有任务时，就需要创建或者唤醒一个系统线程来执行它队列里的任务，所以 P 和 M 是相互绑定的。总的来说，P 可以根据实际情况开启协程去工作，<font style="color:rgb(34, 34, 34);">它包含了运行 goroutine 的资源，如果线程想运行 goroutine，必须先获取 P，P 中还包含了可运行的 G 队列。</font></li>
</ul>
<h3 id="_3">调度过程</h3>
<p>GO 调度器的调度过程，首先创建一个 G 对象，然后 G 被保存在 P 的本地队列或者全局队列（global queue）。这时 P 会唤醒一个 M。P 按照它的执行顺序继续执行任务。M 寻找一个空闲的 P，如果找得到，将 G 与自己绑定。然后 M 执行一个调度循环：调用 G 对象-&gt;执行-&gt;清理线程-&gt;继续寻找 Goroutine。 在 M 的执行过程中，上下文切换随时发生。当切换发生，任务的执行现场需要被保护，这样在下一次调度执行可以进行现场恢复。M 的栈保存在 G 对象中，只有现场恢复需要的寄存器( SP , PC 等)，需要被保存到 G 对象。<br />
如果 G 对象还没有被执行，M 可以将 G 重新放到 P 的调度队列，等待下一次的调度执行。当调度执行时，M可以通过 G 的 vdsoSP, vdsoPC 寄存器进行现场恢复。<br />
线程清理 G 的调度是为了实现 P/M 的绑定，所以线程清理就是释放 P 上的 G，让其他的 G 能够被调度。</p>
<p>在调度中，释放资源的时候分为两种：</p>
<ol>
<li>主动释放 (active release) ：典型的例子是，执行 G 任务时，发生了系统调用(system call)，这时M会<br />
处于阻塞（Block）状态。调度器会设置一个超时时间，来释放 P。 </li>
<li>被动释放(passive release)：如果系统调用发生，监控程序需要扫描处于阻塞状态的 P/M 。 这时，<br />
超时之后，P 资源会回收，程序被安排给队列中的其他G任务。</li>
</ol>
<h3 id="_4"><font style="color:rgb(0,0,0);">源码</font></h3>
<h4 id="g"><font style="color:rgb(0,0,0);">G</font></h4>
<pre><code class="language-go">type g struct {
  stack       stack   // 描述真实的栈内存，包括上下界
  m              *m     // 当前的 m
  sched          gobuf   // goroutine 切换时，用于保存 g 的上下文      
  param          unsafe.Pointer // 用于传递参数，睡眠时其他 goroutine 可以设置 param，唤醒时该goroutine可以获取
  atomicstatus   uint32
  stackLock      uint32 
  goid           int64  // goroutine 的 ID
  waitsince      int64 // g 被阻塞的大体时间
  lockedm        *m     // G 被锁定只在这个 m 上运行
}
</code></pre>
<p><font style="color:rgb(0, 0, 0);">其中 sched 比较重要，该字段保存了 goroutine 的上下文。goroutine 切换的时候不同于线程有 OS 来负责这部分数据，而是由一个 gobuf 结构体来保存，gobuf 的结构如下：</font></p>
<pre><code class="language-go">type gobuf struct {
    sp   uintptr
    pc   uintptr
    g    guintptr
    ctxt unsafe.Pointer
    ret  sys.Uintreg
    lr   uintptr
    bp   uintptr // for GOEXPERIMENT=framepointer
}
</code></pre>
<p><font style="color:rgb(0, 0, 0);">这里可以看出该结构体保存了当前的栈指针，计数器，还有 g 自身，这里记录自身 g 的指针的目的是为了</font><strong><font style="color:rgb(0, 0, 0);">能快速的访问到 goroutine 中的信息</font></strong><font style="color:rgb(0, 0, 0);">。</font></p>
<h4 id="m"><font style="color:rgb(0, 0, 0);">M</font></h4>
<pre><code class="language-go">type m struct {
    g0      *g     // 带有调度栈的goroutine

    gsignal       *g         // 处理信号的goroutine
    tls           [6]uintptr // thread-local storage
    mstartfn      func()
    curg          *g       // 当前运行的goroutine
    caughtsig     guintptr 
    p             puintptr // 关联p和执行的go代码
    nextp         puintptr
    id            int32
    mallocing     int32 // 状态

    spinning      bool // m是否out of work
    blocked       bool // m是否被阻塞
    inwb          bool // m是否在执行写屏蔽

    printlock     int8
    incgo         bool
    fastrand      uint32
    ncgocall      uint64      // cgo调用的总数
    ncgo          int32       // 当前cgo调用的数目
    park          note
    alllink       *m // 用于链接allm
    schedlink     muintptr
    mcache        *mcache // 当前m的内存缓存
    lockedg       *g // 锁定g在当前m上执行，而不会切换到其他m
    createstack   [32]uintptr // thread创建的栈
}
</code></pre>
<p><font style="color:rgb(0, 0, 0);">结构体 M 中，有两个重要的字段：</font></p>
<ul>
<li><font style="color:rgb(0, 0, 0);"> curg：代表结构体M当前绑定的结构体 G 。</font></li>
<li><font style="color:rgb(0, 0, 0);"> g0 ：是带有调度栈的 goroutine，普通的 goroutine 的栈是在</font><strong><font style="color:rgb(0, 0, 0);">堆上</font></strong><font style="color:rgb(0, 0, 0);">分配的可增长的栈，但是 g0 的栈是 </font><strong><font style="color:rgb(0, 0, 0);">M 对应的线程</font></strong><font style="color:rgb(0, 0, 0);">的栈。与调度相关的代码，会先切换到该 goroutine 的栈中再执行。</font></li>
</ul>
<h4 id="p"><font style="color:rgb(0, 0, 0);">P</font></h4>
<pre><code class="language-go">type p struct {
    lock mutex

    id          int32
    status      uint32 // 状态，可以为pidle/prunning/...
    link        puintptr
    schedtick   uint32     // 每调度一次加1
    syscalltick uint32     // 每一次系统调用加1
    sysmontick  sysmontick 
    m           muintptr   // 回链到关联的m
    mcache      *mcache
    racectx     uintptr

    goidcache    uint64 // goroutine的ID的缓存
    goidcacheend uint64

    // 可运行的goroutine的队列
    runqhead uint32
    runqtail uint32
    runq     [256]guintptr

    runnext guintptr // 下一个运行的g

    sudogcache []*sudog
    sudogbuf   [128]*sudog

    palloc persistentAlloc // per-P to avoid mutex

    pad [sys.CacheLineSize]byte
}
</code></pre>
<ul>
<li><font style="color:rgb(0, 0, 0);">P 的个数就是 GOMAXPROCS（最大256），启动时固定的，一般不修改；</font><font style="color:rgb(51,51,51);">GOMAXPOCS 默认值是当前电脑的核心数，单核CPU就只能设置为1，如果设置&gt;1，在 GOMAXPOCS 函数中也会被修改为1。</font></li>
<li><font style="color:rgb(0, 0, 0);">M 的个数和P 的个数不一定一样多（会有休眠的M或者不需要太多的 M）（M 最大10000）；</font></li>
<li><font style="color:rgb(0, 0, 0);">每一个 P 保存着本地 G 任务队列，也有一个全局 G 任务队列。</font></li>
</ul>
<h3 id="_5"><font style="color:rgb(0, 0, 0);">模型介绍</font></h3>
<p><img alt="画板" src="../img/76ZO1iY98RZ-rd1i/1648716696731-0d4e04b1-da32-4ff8-ac44-f2f74cfb7629-332120.jpeg" /></p>
<p><strong><font style="color:rgb(0, 0, 0);">本地队列</font></strong><font style="color:rgb(0, 0, 0);">：存放等待运行的 G，一个本地队列存放的G数量一般不超过 256 个，优先将新创建的 G 放在 P 的本地队列中，如果满了会放在全局队列中。</font>本地的队列是无锁的，没有数据竞争问题，处理速度比较高。</p>
<p><strong><font style="color:rgb(0, 0, 0);">全局队列</font></strong><font style="color:rgb(0, 0, 0);">：存放等待运行的 G，读写要</font><strong><font style="color:rgb(0, 0, 0);">加锁</font></strong><font style="color:rgb(0, 0, 0);">，所以拿取效率在多线程竞争的情况下相比于本地队列来说要低。</font>用来平衡不同的 P 的任务数量，所有的 M 共享 P 的全局队列。</p>
<h2 id="_6"><font style="color:rgb(0, 0, 0);">面试回答模板</font></h2>
<p>首先呢，GMP 这三个字母的含义分别是 Goroutine，Machine，Processor。这个 <font style="color:rgb(0,0,0);">Goroutine，</font><font style="color:rgb(51, 51, 51);">相当于操作系统中的进程控制块。G 结构体中</font><font style="color:rgb(0,0,0);">其中</font><font style="color:rgb(0, 0, 0);">存着 goroutine 的运行时栈信息，CPU 的一些寄存器的值以及执行的函数指令等。</font><font style="color:rgb(0,0,0);">Machine就是代表了一个操作系统的主线。</font>M 结构体中，保存了 M 自身使用的栈信息、当前正在 M上执行的 G 信息、与之绑定的 P 信息。<font style="color:rgb(0, 0, 0);">M 直接关联一个 os 内核线程，用于执行 G。（这里思考一个这个模型的图片回答），这个 </font>M 做的事情就是从关联的 P 的本地队列中直接获取待执行的 G。剩下的 <font style="color:rgb(0, 0, 0);">Processor 是代表了 </font>M 所需<font style="color:rgb(0, 0, 0);">的上下文环境，</font>代表 M 运行 G 所需要的资源<font style="color:rgb(102, 102, 102);">。</font>当 P 有任务时，就需要创建或者唤醒一个系统线程来执行它队列里的任务。在GMP调度模型中，<font style="color:rgb(0, 0, 0);">P 的个数就是 GOMAXPROCS，是可以手动设置的，但一般不修改，</font><font style="color:rgb(51,51,51);">GOMAXPOCS 默认值是当前电脑的核心数，单核CPU就只能设置为1，如果设置&gt;1，在 GOMAXPOCS 函数中也会被修改为1。</font>总的来说，这个 P 结构体的主要的任务就是可以根据实际情况开启协程去工作。</p>
<h1 id="_7"></h1>
<blockquote>
<p>更新: 2022-11-14 00:49:54<br />
原文: <a href="https://www.yuque.com/xiaoshan_wgo/codingnotes/ie4sgv">https://www.yuque.com/xiaoshan_wgo/codingnotes/ie4sgv</a></p>
</blockquote>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../../..", "features": [], "search": "../../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>